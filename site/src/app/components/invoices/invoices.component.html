<mat-card>
  <mat-card-header>
    <mat-card-title>Gestión de Facturas</mat-card-title>
    <mat-card-subtitle>Administra todas tus facturas desde aquí</mat-card-subtitle>
  </mat-card-header>

  <mat-card-content>
    <!-- Actions -->
    <div class="button-row">
      <button mat-raised-button (click)="importInvoices()">
        <mat-icon>upload</mat-icon>
        Importar
      </button>
      <button mat-raised-button color="primary" (click)="createInvoice()">
        <mat-icon>add</mat-icon>
        Nueva Factura
      </button>
    </div>

    <!-- Stats Cards -->
    <div class="stats-container">
      <mat-grid-list cols="4" rowHeight="100px">
        <mat-grid-tile>
          <mat-card class="stats-card">
            <mat-card-header>
              <mat-card-title>{{stats.total}}</mat-card-title>
              <mat-card-subtitle>Total Facturas</mat-card-subtitle>
            </mat-card-header>
          </mat-card>
        </mat-grid-tile>
        <mat-grid-tile>
          <mat-card class="stats-card">
            <mat-card-header>
              <mat-card-title>{{stats.pending}}</mat-card-title>
              <mat-card-subtitle>Pendientes</mat-card-subtitle>
            </mat-card-header>
          </mat-card>
        </mat-grid-tile>
        <mat-grid-tile>
          <mat-card class="stats-card">
            <mat-card-header>
              <mat-card-title>{{stats.paid}}</mat-card-title>
              <mat-card-subtitle>Pagadas</mat-card-subtitle>
            </mat-card-header>
          </mat-card>
        </mat-grid-tile>
        <mat-grid-tile>
          <mat-card class="stats-card">
            <mat-card-header>
              <mat-card-title>${{formatCurrency(stats.totalAmount)}}</mat-card-title>
              <mat-card-subtitle>Monto Total</mat-card-subtitle>
            </mat-card-header>
          </mat-card>
        </mat-grid-tile>
      </mat-grid-list>
    </div>

    <!-- Filters -->
    <div class="filters-container">
      <mat-form-field appearance="outline">
        <mat-label>Buscar</mat-label>
        <input matInput (keyup)="applyFilter($event)" placeholder="Buscar facturas...">
        <mat-icon matPrefix>search</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Estado</mat-label>
        <mat-select [(value)]="statusFilter" (selectionChange)="applyStatusFilter($event.value)">
          <mat-option [value]="">Todos</mat-option>
          <mat-option value="pending">Pendientes</mat-option>
          <mat-option value="paid">Pagadas</mat-option>
          <mat-option value="cancelled">Canceladas</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Período</mat-label>
        <mat-select [(value)]="dateRange" (selectionChange)="applyDateFilter($event.value)">
          <mat-option [value]="">Todo el tiempo</mat-option>
          <mat-option value="today">Hoy</mat-option>
          <mat-option value="week">Esta semana</mat-option>
          <mat-option value="month">Este mes</mat-option>
          <mat-option value="quarter">Este trimestre</mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <!-- Loading Progress -->
    <mat-progress-bar *ngIf="loading" mode="indeterminate"></mat-progress-bar>

    <!-- Error Message -->
    <div *ngIf="error" class="error-message">
      <mat-icon>error</mat-icon>
      <span>{{error}}</span>
      <button mat-button color="primary" (click)="loadInvoices()">Reintentar</button>
    </div>

    <!-- Table -->
    <div class="mat-elevation-z8 table-container" *ngIf="!loading && !error">

      <table mat-table [dataSource]="dataSource" matSort>
        <!-- Invoice Number Column -->
        <ng-container matColumnDef="invoice_number">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Factura </th>
          <td mat-cell *matCellDef="let invoice"> 
            <div>
              <div class="primary-text">#{{invoice.invoice_number}}</div>
              <div class="secondary-text">{{formatDate(invoice.issue_date)}}</div>
            </div>
          </td>
        </ng-container>

        <!-- Client Column -->
        <ng-container matColumnDef="client.name">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Cliente </th>
          <td mat-cell *matCellDef="let invoice">
            <div>
              <div class="primary-text">{{invoice.client?.name || 'Sin cliente'}}</div>
              <div class="secondary-text">{{invoice.client?.email || ''}}</div>
            </div>
          </td>
        </ng-container>

        <!-- Amount Column -->
        <ng-container matColumnDef="amount">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Monto </th>
          <td mat-cell *matCellDef="let invoice"> ${{formatCurrency(invoice.amount)}} </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Estado </th>
          <td mat-cell *matCellDef="let invoice">
            <mat-chip [ngClass]="{
              'status-pending': invoice.status === 'pending',
              'status-paid': invoice.status === 'paid',
              'status-cancelled': invoice.status === 'cancelled'
            }">
              {{getStatusLabel(invoice.status)}}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Due Date Column -->
        <ng-container matColumnDef="due_date">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Vencimiento </th>
          <td mat-cell *matCellDef="let invoice">
            <div [ngClass]="{
              'text-overdue': isOverdue(invoice.due_date),
              'text-due-soon': isDueSoon(invoice.due_date)
            }">
              {{formatDate(invoice.due_date)}}
              <mat-icon *ngIf="isOverdue(invoice.due_date)" class="warning-icon">warning</mat-icon>
            </div>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef> Acciones </th>
          <td mat-cell *matCellDef="let invoice">
            <button mat-icon-button [matMenuTriggerFor]="menu">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #menu="matMenu">
              <button mat-menu-item (click)="viewInvoice(invoice)">
                <mat-icon>visibility</mat-icon>
                <span>Ver detalles</span>
              </button>
              <button mat-menu-item (click)="editInvoice(invoice)">
                <mat-icon>edit</mat-icon>
                <span>Editar</span>
              </button>
              <button mat-menu-item (click)="duplicateInvoice(invoice)">
                <mat-icon>content_copy</mat-icon>
                <span>Duplicar</span>
              </button>
              <button mat-menu-item (click)="downloadInvoice(invoice)">
                <mat-icon>download</mat-icon>
                <span>Descargar PDF</span>
              </button>
              <mat-divider></mat-divider>
              <button mat-menu-item (click)="deleteInvoice(invoice)" class="delete-action">
                <mat-icon>delete</mat-icon>
                <span>Eliminar</span>
              </button>
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

        <!-- Row shown when there is no matching data. -->
        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell" colspan="6">
            <div class="empty-state">
              <mat-icon>receipt</mat-icon>
              <h3>No hay facturas</h3>
              <p>
                {{searchTerm || statusFilter || dateRange ? 
                  'No se encontraron facturas con los filtros aplicados.' : 
                  'Comienza creando tu primera factura.'}}
              </p>
              <button *ngIf="!searchTerm && !statusFilter && !dateRange" 
                      mat-raised-button 
                      color="primary" 
                      (click)="createInvoice()">
                <mat-icon>add</mat-icon>
                Crear Primera Factura
              </button>
            </div>
          </td>
        </tr>
      </table>

      <mat-paginator [pageSizeOptions]="[5, 10, 25, 100]" 
                     showFirstLastButtons 
                     aria-label="Seleccionar página de facturas">
      </mat-paginator>
    </div>
  </mat-card-content>
</mat-card>

<!-- Delete Confirmation Dialog -->
<div *ngIf="showDeleteModal">
  <mat-dialog-content>
    <div class="delete-dialog-content">
      <mat-icon class="warning-icon">warning</mat-icon>
      <h2>Eliminar Factura</h2>
      <p>¿Estás seguro de que deseas eliminar la factura #{{invoiceToDelete?.invoice_number}}?</p>
      <p class="warning-text">Esta acción no se puede deshacer.</p>
    </div>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button (click)="cancelDelete()">Cancelar</button>
    <button mat-raised-button color="warn" (click)="confirmDelete()">Eliminar</button>
  </mat-dialog-actions>
</div>