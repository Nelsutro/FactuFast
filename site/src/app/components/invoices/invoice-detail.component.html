<div class="detail-container" *ngIf="!loading; else loadingState">
  <ng-container *ngIf="invoice; else errorState">
    <div class="toolbar">
      <button mat-button color="primary" (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
        Volver a facturas
      </button>
      <div class="toolbar-actions">
        <button mat-stroked-button color="primary" (click)="refresh()">
          <mat-icon>refresh</mat-icon>
          Recargar
        </button>
        <button mat-stroked-button (click)="downloadPdf()">
          <mat-icon>picture_as_pdf</mat-icon>
          Descargar PDF
        </button>
      </div>
    </div>

    <mat-card class="summary-card">
      <mat-card-header>
        <div mat-card-avatar class="summary-avatar">
          <mat-icon>receipt</mat-icon>
        </div>
        <mat-card-title>Factura #{{ invoice?.invoice_number }}</mat-card-title>
        <mat-card-subtitle>Emitida el {{ formatDate(invoice?.issue_date) }}</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="summary-grid">
          <div>
            <span class="label">Estado</span>
            <span class="value">
              <span [ngClass]="getStatusChipClass(invoice?.status)">
                {{ invoice?.status | titlecase }}
              </span>
            </span>
          </div>
          <div>
            <span class="label">Monto total</span>
            <span class="value">${{ formatCurrency(invoice?.amount) }}</span>
          </div>
          <div>
            <span class="label">Vencimiento</span>
            <span class="value">{{ formatDate(invoice?.due_date) }}</span>
          </div>
          <div>
            <span class="label">Cliente</span>
            <span class="value">{{ invoice?.client?.name || '—' }}</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <div class="grid-layout">
      <mat-card>
        <mat-card-header>
          <mat-card-title>Datos del cliente</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="info-row">
            <span class="label">Nombre</span>
            <span class="value">{{ invoice?.client?.name || '—' }}</span>
          </div>
          <div class="info-row" *ngIf="invoice?.client?.email">
            <span class="label">Email</span>
            <span class="value">{{ invoice?.client?.email }}</span>
          </div>
          <div class="info-row" *ngIf="invoice?.client?.tax_id">
            <span class="label">RUT</span>
            <span class="value">{{ invoice?.client?.tax_id }}</span>
          </div>
          <div class="info-row" *ngIf="invoice?.client?.phone">
            <span class="label">Teléfono</span>
            <span class="value">{{ invoice?.client?.phone }}</span>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card>
        <mat-card-header>
          <mat-card-title>Notas</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <p class="notes" *ngIf="invoice?.notes; else noNotes">{{ invoice?.notes }}</p>
          <ng-template #noNotes>
            <p class="notes empty">Sin notas registradas.</p>
          </ng-template>
        </mat-card-content>
      </mat-card>
    </div>

    <mat-card>
      <mat-card-header>
        <mat-card-title>Ítems</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <table class="items-table" *ngIf="hasItems(); else emptyItems">
          <thead>
            <tr>
              <th>Descripción</th>
              <th class="numeric">Cantidad</th>
              <th class="numeric">Precio</th>
              <th class="numeric">Subtotal</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of invoice?.items">
              <td>{{ item.description }}</td>
              <td class="numeric">{{ item.quantity }}</td>
              <td class="numeric">${{ formatCurrency(item.unit_price || item.price) }}</td>
              <td class="numeric">${{ formatCurrency(item.amount ?? (item.quantity * item.unit_price)) }}</td>
            </tr>
          </tbody>
        </table>
        <ng-template #emptyItems>
          <div class="empty-section">
            <mat-icon>list_alt</mat-icon>
            <p>No hay ítems registrados para esta factura.</p>
          </div>
        </ng-template>
      </mat-card-content>
    </mat-card>

    <mat-card *ngIf="hasPayments()">
      <mat-card-header>
        <mat-card-title>Pagos registrados</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="payments">
          <div class="payment" *ngFor="let payment of invoice?.payments">
            <div>
              <span class="label">Fecha</span>
              <span class="value">{{ formatDate(payment.payment_date || payment.created_at) }}</span>
            </div>
            <div>
              <span class="label">Monto</span>
              <span class="value">${{ formatCurrency(payment.amount) }}</span>
            </div>
            <div>
              <span class="label">Método</span>
              <span class="value">{{ payment.payment_method || payment.method || '—' }}</span>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </ng-container>
</div>

<ng-template #loadingState>
  <div class="loading-wrapper">
    <app-loading message="Cargando factura..." [diameter]="64"></app-loading>
  </div>
</ng-template>

<ng-template #errorState>
  <div class="error-state">
    <mat-icon color="warn">error_outline</mat-icon>
    <h3>{{ error }}</h3>
    <button mat-flat-button color="primary" (click)="goBack()">Volver</button>
  </div>
</ng-template>
