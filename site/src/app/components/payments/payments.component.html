<div class="payments-container">
  <!-- Header -->
  <mat-card class="header-card">
    <mat-card-header>
      <mat-card-title>Gestión de Pagos</mat-card-title>
      <mat-card-subtitle>Seguimiento de pagos y conciliación bancaria</mat-card-subtitle>
    </mat-card-header>
    <mat-card-actions align="end">
      <button mat-stroked-button color="primary" (click)="reconcilePayments()">
        <mat-icon>sync</mat-icon>
        Conciliar
      </button>
      <button mat-raised-button color="primary" (click)="recordPayment()">
        <mat-icon>add</mat-icon>
        Registrar Pago
      </button>
    </mat-card-actions>
  </mat-card>

  <!-- Payment Stats -->
  <mat-grid-list cols="4" rowHeight="140px" gutterSize="16px" class="stats-grid">
    <mat-grid-tile>
      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-content">
            <div class="stat-info">
              <span class="stat-label">Pagos del Mes</span>
              <span class="stat-value">{{ stats.monthlyPayments }}</span>
            </div>
            <div class="stat-icon success">
              <mat-icon>payments</mat-icon>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </mat-grid-tile>

    <mat-grid-tile>
      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-content">
            <div class="stat-info">
              <span class="stat-label">Monto Recaudado</span>
              <span class="stat-value">${{ formatCurrency(stats.totalCollected) }}</span>
            </div>
            <div class="stat-icon primary">
              <mat-icon>trending_up</mat-icon>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </mat-grid-tile>

    <mat-grid-tile>
      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-content">
            <div class="stat-info">
              <span class="stat-label">Pagos Pendientes</span>
              <span class="stat-value">{{ stats.pendingPayments }}</span>
            </div>
            <div class="stat-icon warning">
              <mat-icon>schedule</mat-icon>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </mat-grid-tile>

    <mat-grid-tile>
      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-content">
            <div class="stat-info">
              <span class="stat-label">Pagos Fallidos</span>
              <span class="stat-value">{{ stats.failedPayments }}</span>
            </div>
            <div class="stat-icon error">
              <mat-icon>error_outline</mat-icon>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </mat-grid-tile>
  </mat-grid-list>

  <!-- Filters -->
  <mat-card class="filters-card">
    <mat-card-content>
      <div class="filters-grid">
        <!-- Search -->
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Buscar</mat-label>
          <input matInput
                 [(ngModel)]="searchTerm"
                 (keyup)="applyFilter($event)"
                 placeholder="Factura, cliente, método...">
          <mat-icon matPrefix>search</mat-icon>
        </mat-form-field>

        <!-- Status Filter -->
        <mat-form-field appearance="outline">
          <mat-label>Estado</mat-label>
          <mat-select [(value)]="statusFilter" (selectionChange)="applyStatusFilter($event.value)">
            <mat-option value="">Todos</mat-option>
            <mat-option value="completed">Completados</mat-option>
            <mat-option value="pending">Pendientes</mat-option>
            <mat-option value="failed">Fallidos</mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Method Filter -->
        <mat-form-field appearance="outline">
          <mat-label>Método</mat-label>
          <mat-select [(value)]="methodFilter" (selectionChange)="applyMethodFilter($event.value)">
            <mat-option value="">Todos</mat-option>
            <mat-option value="credit_card">Tarjeta</mat-option>
            <mat-option value="bank_transfer">Transferencia</mat-option>
            <mat-option value="cash">Efectivo</mat-option>
            <mat-option value="other">Otro</mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Date Range -->
        <mat-form-field appearance="outline">
          <mat-label>Período</mat-label>
          <mat-select [(value)]="dateRange" (selectionChange)="applyDateFilter($event.value)">
            <mat-option value="">Todo</mat-option>
            <mat-option value="today">Hoy</mat-option>
            <mat-option value="week">Esta semana</mat-option>
            <mat-option value="month">Este mes</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner diameter="48"></mat-spinner>
  </div>

  <!-- Payments List -->
  <mat-card *ngIf="!loading && !error" class="payments-table-card">
    <table mat-table [dataSource]="dataSource" class="payments-table">
      <!-- Invoice Column -->
      <ng-container matColumnDef="invoice">
        <th mat-header-cell *matHeaderCellDef>Factura</th>
        <td mat-cell *matCellDef="let payment">
          <div class="cell-content">
            <span class="primary-text">#{{payment.invoice?.invoice_number || 'N/A'}}</span>
            <span class="secondary-text">ID: {{payment.id}}</span>
          </div>
        </td>
      </ng-container>

      <!-- Client Column -->
      <ng-container matColumnDef="client">
        <th mat-header-cell *matHeaderCellDef>Cliente</th>
        <td mat-cell *matCellDef="let payment">
          <div class="cell-content">
            <span class="primary-text">{{payment.invoice?.client?.name || 'N/A'}}</span>
            <span class="secondary-text">{{payment.invoice?.client?.email || ''}}</span>
          </div>
        </td>
      </ng-container>

      <!-- Amount Column -->
      <ng-container matColumnDef="amount">
        <th mat-header-cell *matHeaderCellDef>Monto</th>
        <td mat-cell *matCellDef="let payment">
          <div class="cell-content">
            <span class="primary-text">${{formatCurrency(payment.amount)}}</span>
            <span class="secondary-text" *ngIf="payment.invoice">
              de ${{formatCurrency(payment.invoice.amount)}}
            </span>
          </div>
        </td>
      </ng-container>

      <!-- Method Column -->
      <ng-container matColumnDef="method">
        <th mat-header-cell *matHeaderCellDef>Método</th>
        <td mat-cell *matCellDef="let payment">
          <div class="payment-method">
            <mat-icon [ngClass]="{
              'text-primary': payment.method === 'credit_card',
              'text-success': payment.method === 'bank_transfer',
              'text-warning': payment.method === 'cash',
              'text-gray': payment.method === 'other'
            }">
              {{getMethodIcon(payment.method)}}
            </mat-icon>
            <span>{{getMethodLabel(payment.method)}}</span>
          </div>
        </td>
      </ng-container>

      <!-- Status Column -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Estado</th>
        <td mat-cell *matCellDef="let payment">
          <mat-chip [ngClass]="{
            'status-completed': payment.status === 'completed',
            'status-pending': payment.status === 'pending',
            'status-failed': payment.status === 'failed'
          }">
            {{getStatusLabel(payment.status)}}
          </mat-chip>
        </td>
      </ng-container>

      <!-- Date Column -->
      <ng-container matColumnDef="date">
        <th mat-header-cell *matHeaderCellDef>Fecha</th>
        <td mat-cell *matCellDef="let payment">
          {{formatDate(payment.payment_date)}}
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef class="actions-header">Acciones</th>
        <td mat-cell *matCellDef="let payment" class="actions-cell">
          <button mat-icon-button [matMenuTriggerFor]="menu" aria-label="Acciones">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #menu="matMenu">
            <button mat-menu-item (click)="viewPayment(payment)">
              <mat-icon>visibility</mat-icon>
              <span>Ver detalles</span>
            </button>
            <button mat-menu-item *ngIf="payment.status === 'pending'"
                    (click)="processPayment(payment)">
              <mat-icon>check_circle</mat-icon>
              <span>Procesar pago</span>
            </button>
            <button mat-menu-item *ngIf="payment.status === 'failed'"
                    (click)="retryPayment(payment)">
              <mat-icon>refresh</mat-icon>
              <span>Reintentar pago</span>
            </button>
            <button mat-menu-item (click)="downloadReceipt(payment)">
              <mat-icon>receipt</mat-icon>
              <span>Descargar comprobante</span>
            </button>
          </mat-menu>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>

      <!-- Empty State -->
      <div *ngIf="filteredPayments.length === 0" class="empty-state">
        <mat-icon class="empty-icon">credit_card</mat-icon>
        <h3 class="empty-title">No hay pagos</h3>
        <p class="empty-description">
          {{ searchTerm || statusFilter || methodFilter || dateRange ? 
             'No se encontraron pagos con los filtros aplicados.' : 
             'Los pagos aparecerán aquí una vez que se registren.' }}
        </p>
      </div>
    </mat-card>

    <!-- Pagination -->
    <mat-paginator *ngIf="filteredPayments.length > 0"
                  [length]="filteredPayments.length"
                  [pageSize]="pageSize"
                  [pageSizeOptions]="[9, 18, 27]"
                  (page)="onPageChange($event)"
                  aria-label="Seleccionar página de pagos">
    </mat-paginator>
