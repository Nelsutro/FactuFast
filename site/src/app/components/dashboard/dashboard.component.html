<div class="dashboard-container">
  <div class="dashboard-inner">

  <!-- Header Section -->
  <div class="header-section">
    <mat-card class="welcome-card">
      <mat-card-content>
        <div class="header-content">
          <div class="welcome-info">
            <h1 class="welcome-title">Bienvenido{{ currentUser?.name ? ', ' + currentUser?.name : '' }}</h1>
            <p class="welcome-subtitle">Aquí tienes un resumen de tu actividad financiera</p>
            <div *ngIf="currentUser" class="user-info">
              <p *ngIf="currentUser.company_name"><strong>Empresa:</strong> {{ currentUser.company_name }}</p>
              <p><strong>Rol:</strong> {{ currentUser.role | titlecase }}</p>
            </div>
          </div>
          <div class="header-actions">
            <button mat-raised-button color="warn" (click)="logout()">
              <mat-icon>logout</mat-icon>
              Cerrar Sesión
            </button>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Loading / Error -->
  <app-loading *ngIf="loading" message="Cargando dashboard..." [diameter]="56"></app-loading>

  <div *ngIf="error" class="error-message">
    <mat-icon>error</mat-icon>
    <span>{{ error }}</span>
    <button mat-button color="primary" (click)="loadDashboardData()">
      <mat-icon>refresh</mat-icon>
      Reintentar
    </button>
  </div>

  <!-- Dashboard Content -->
  <div *ngIf="!loading && !error">

    <!-- Stats Cards -->
    <div class="stats-cards" fxLayout="row" fxLayoutGap="16px" fxLayoutWrap>
      <mat-card class="stat-card" *ngFor="let stat of [
        { label: 'Facturas Pendientes', value: dashboardStats?.pending_invoices, icon: 'schedule', trend: '+12%' },
        { label: 'Facturas Pagadas', value: dashboardStats?.paid_invoices, icon: 'check_circle', trend: '+8%' },
        { label: 'Total Facturado', value: '$' + formatCurrency(dashboardStats?.total_revenue ?? 0), icon: 'attach_money', trend: '+15%' },
        { label: 'Cotizaciones Activas', value: dashboardStats?.active_quotes, icon: 'format_quote', trend: '+3%' }
      ]">
        <mat-card-content>
          <div class="stat-content">
            <div class="stat-info">
              <p class="stat-label">{{ stat.label }}</p>
              <p class="stat-value">{{ stat.value || 0 }}</p>
            </div>
            <div class="stat-icon">
              <mat-icon>{{ stat.icon }}</mat-icon>
            </div>
          </div>
          <div class="stat-trend">
            <mat-icon>arrow_upward</mat-icon>
            <span>{{ stat.trend }} vs mes anterior</span>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <div class="stats-cards import-cards" fxLayout="row" fxLayoutGap="16px" fxLayoutWrap *ngIf="importMetrics as metrics">
      <mat-card class="stat-card success" fxFlex="1 1 30%">
        <mat-card-content>
          <div class="stat-content">
            <div class="stat-info">
              <p class="stat-label">Filas procesadas (7 días)</p>
              <p class="stat-value">{{ metrics.rows_processed | number:'1.0-0' }}</p>
            </div>
            <div class="stat-icon">
              <mat-icon>dataset</mat-icon>
            </div>
          </div>
          <div class="stat-trend">
            <mat-icon>schedule</mat-icon>
            <span>{{ metrics.recent_batches }} lotes recientes</span>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card accent" fxFlex="1 1 30%">
        <mat-card-content>
          <div class="stat-content">
            <div class="stat-info">
              <p class="stat-label">Tasa de éxito</p>
              <p class="stat-value">{{ formatImportSuccess(metrics) }}</p>
            </div>
            <div class="stat-icon">
              <mat-icon>percent</mat-icon>
            </div>
          </div>
          <div class="stat-trend">
            <mat-icon>error_outline</mat-icon>
            <span>{{ metrics.error_rows | number:'1.0-0' }} filas con error</span>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card warn" fxFlex="1 1 30%">
        <mat-card-content>
          <div class="stat-content">
            <div class="stat-info">
              <p class="stat-label">Lotes pendientes</p>
              <p class="stat-value">{{ metrics.pending_batches }}</p>
            </div>
            <div class="stat-icon">
              <mat-icon>hourglass_empty</mat-icon>
            </div>
          </div>
          <div class="stat-trend">
            <mat-icon>report_problem</mat-icon>
            <span>{{ metrics.failed_batches }} lotes fallidos</span>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Main Section: Charts + Quick Actions -->
<div class="main-section" fxLayout="row" fxLayoutGap="16px" fxLayoutAlign="start stretch" fxLayoutWrap>

  <!-- Charts Column (2/3) -->
  <div fxFlex="66%">
    <div class="charts-section" fxLayout="row" fxLayoutGap="16px" fxLayoutWrap>
      <mat-card class="chart-card" fxFlex="1 1 48%">
        <mat-card-header>
          <mat-card-title>Ingresos Mensuales</mat-card-title>
          <mat-card-subtitle>
            <mat-form-field appearance="outline" class="chart-select">
              <mat-label>Periodo</mat-label>
              <mat-select [(ngModel)]="chartPeriod" (selectionChange)="onChartPeriodChange()">
                <mat-option value="6m">Últimos 6 meses</mat-option>
                <mat-option value="1y">Este año</mat-option>
              </mat-select>
            </mat-form-field>
          </mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <canvas #revenueChart></canvas>
        </mat-card-content>
      </mat-card>

      <mat-card class="chart-card" fxFlex="1 1 48%">
        <mat-card-header>
          <mat-card-title>Estado de Facturas</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <canvas #statusChart></canvas>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Quick Actions Column (1/3) -->
  <div fxFlex="32%">
    <mat-card class="actions-card">
      <mat-card-header>
        <mat-card-title>Acciones Rápidas</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="action-buttons" fxLayout="column" fxLayoutGap="8px">
          <button mat-raised-button color="primary" (click)="createInvoice()">
            <mat-icon>add</mat-icon> Nueva Factura
          </button>
          <button mat-raised-button color="accent" (click)="createQuote()">
            <mat-icon>format_quote</mat-icon> Nueva Cotización
          </button>
          <button mat-raised-button color="primary" (click)="createClient()">
            <mat-icon>person_add</mat-icon> Agregar Cliente
          </button>
          <button mat-stroked-button color="primary" (click)="importInvoices()">
            <mat-icon>file_upload</mat-icon> Importar Facturas
          </button>
          <button mat-stroked-button (click)="goToClients()">
            <mat-icon>groups</mat-icon> Ver Clientes
          </button>
          <button mat-stroked-button (click)="goToQuotes()">
            <mat-icon>article</mat-icon> Ver Cotizaciones
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  </div>
</div>

    <!-- Recent Activity & Quick Actions -->
    <div class="activity-section" fxLayout="row" fxLayoutGap="16px" fxLayoutWrap>

      <!-- Recent Invoices -->
      <mat-card fxFlex="2 1 65%" class="recent-invoices-card">
        <mat-card-header>
          <mat-card-title>Facturas Recientes</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <mat-list *ngIf="dashboardStats?.recent_invoices?.length; else noInvoices">
            <mat-list-item *ngFor="let invoice of dashboardStats?.recent_invoices"
                           (click)="viewInvoice(invoice.id)"
                           class="invoice-list-item">
              <mat-icon>{{ getStatusIcon(invoice.status) }}</mat-icon>
              <div class="invoice-details">
                <p class="invoice-number">Factura #{{ invoice.invoice_number }}</p>
                <p class="invoice-client">{{ invoice.client?.name || 'Cliente no especificado' }}</p>
              </div>
              <mat-chip class="status-chip" [ngClass]="getStatusChipClass(invoice.status)">
                {{ getStatusLabel(invoice.status) }}
              </mat-chip>
              <p class="invoice-amount">${{ formatCurrency(invoice.amount) }}</p>
            </mat-list-item>
          </mat-list>

          <ng-template #noInvoices>
            <div class="no-invoices">
              <mat-icon>receipt_long</mat-icon>
              <p>No hay facturas recientes</p>
            </div>
          </ng-template>

          <div class="view-all-container" *ngIf="dashboardStats?.recent_invoices?.length">
            <button mat-button color="primary" (click)="goToInvoices()">
              <mat-icon>visibility</mat-icon> Ver todas las facturas
            </button>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Quick Actions & Alerts -->
      <mat-card fxFlex="1 1 32%" class="actions-card">
        <mat-card-header>
          <mat-card-title>Importaciones y alertas</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="import-summary" *ngIf="importMetrics as metrics; else noImportMetrics">
            <h4>Resumen de importaciones</h4>
            <mat-list>
              <mat-list-item>
                <mat-icon color="primary">update</mat-icon>
                Último lote: {{ metrics.last_import_at ? (metrics.last_import_at | date:'short') : 'Sin registros' }}
              </mat-list-item>
              <mat-list-item>
                <mat-icon color="accent">timelapse</mat-icon>
                Duración promedio: {{ formatDuration(metrics.avg_duration_seconds) }}
              </mat-list-item>
              <mat-list-item>
                <mat-icon color="warn">error</mat-icon>
                Errores recientes: {{ metrics.error_rows | number:'1.0-0' }} filas
              </mat-list-item>
            </mat-list>
          </div>

          <ng-template #noImportMetrics>
            <div class="import-summary empty">
              <mat-icon color="primary">cloud_upload</mat-icon>
              <p>Aún no hay cargas registradas.</p>
            </div>
          </ng-template>

          <!-- Alerts -->
          <div class="alerts-section" fxLayout="column" fxLayoutGap="4px" style="margin-top:16px;">
            <h4>Alertas</h4>
            <mat-list>
              <mat-list-item *ngIf="alerts.importsFailed > 0">
                <mat-icon color="warn">report</mat-icon>
                {{ alerts.importsFailed }} lotes fallidos esperando revisión
              </mat-list-item>
              <mat-list-item *ngIf="alerts.importsPending > 0">
                <mat-icon color="accent">hourglass_top</mat-icon>
                {{ alerts.importsPending }} lotes en cola
              </mat-list-item>
              <mat-list-item *ngIf="alerts.overdue > 0">
                <mat-icon color="warn">warning</mat-icon>
                {{ alerts.overdue }} facturas vencidas
              </mat-list-item>
              <mat-list-item *ngIf="alerts.pending > 0">
                <mat-icon color="accent">schedule</mat-icon>
                {{ alerts.pending }} pagos pendientes
              </mat-list-item>
              <mat-list-item *ngIf="alerts.quotes > 0">
                <mat-icon color="primary">format_quote</mat-icon>
                {{ alerts.quotes }} cotizaciones esperando respuesta
              </mat-list-item>
              <mat-list-item *ngIf="alerts.importsFailed===0 && alerts.importsPending===0 && alerts.overdue===0 && alerts.pending===0 && alerts.quotes===0">
                <mat-icon color="primary">check_circle</mat-icon> Todo al día
              </mat-list-item>
            </mat-list>
          </div>
        </mat-card-content>
      </mat-card>

    </div>
  </div>
</div>
