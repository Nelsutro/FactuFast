<mat-toolbar class="header-toolbar" role="banner" aria-label="Barra superior">
  <div class="header-content">
    <!-- Botón de menú -->
    <button mat-icon-button class="menu-button" (click)="toggleSidebar()" aria-label="Abrir menú lateral" matTooltip="Menú">
      <mat-icon aria-hidden="true">menu</mat-icon>
    </button>

    <!-- Logo y título -->
    <div class="brand" (click)="goHome()" role="button" tabindex="0" aria-label="Ir al inicio">
      <mat-icon class="brand-icon" aria-hidden="true">receipt</mat-icon>
      <span class="brand-name">FactuFast</span>
    </div>

    <!-- Título dinámico -->
    <div class="page-title hide-mobile" *ngIf="pageTitle">{{ pageTitle }}</div>

    <!-- Navegación principal -->
    <nav class="primary-nav hide-mobile" *ngIf="isAuthenticated">
      <button mat-button class="nav-link"
              type="button"
              (click)="navigateTo(dashboardLink.route)"
              [class.active]="isNavActive(dashboardLink.route)">
        <mat-icon aria-hidden="true">{{ dashboardLink.icon }}</mat-icon>
        <span>{{ dashboardLink.label }}</span>
      </button>

      <ng-container *ngFor="let section of navSections">
        <ng-container *ngIf="canDisplaySection(section)">
          <button mat-button class="nav-link nav-group"
                  type="button"
                  [matMenuTriggerFor]="sectionMenu"
                  [class.active]="isSectionActive(section)">
            <mat-icon aria-hidden="true">{{ section.icon }}</mat-icon>
            <span>{{ section.label }}</span>
          </button>
          <mat-menu #sectionMenu="matMenu" class="nav-section-menu">
            <ng-container *ngFor="let link of section.items">
              <button mat-menu-item type="button" *ngIf="canDisplayNavLink(link)" (click)="navigateTo(link.route)">
                <mat-icon aria-hidden="true">{{ link.icon }}</mat-icon>
                <span>{{ link.label }}</span>
              </button>
            </ng-container>
          </mat-menu>
        </ng-container>
      </ng-container>
    </nav>

    <span class="spacer"></span>

    <button mat-button class="about-link hide-mobile" (click)="goToAbout()" aria-label="Conocer FactuFast" matTooltip="Sobre FactuFast">
      <mat-icon aria-hidden="true">travel_explore</mat-icon>
      <span>Sobre FactuFast</span>
    </button>

    <button mat-icon-button class="about-link show-mobile" *ngIf="isAuthenticated" (click)="goToAbout()" aria-label="Sobre FactuFast" matTooltip="Sobre FactuFast">
      <mat-icon aria-hidden="true">travel_explore</mat-icon>
    </button>

    <!-- Acciones rápidas -->
    <button mat-icon-button [matMenuTriggerFor]="quickCreateMenu" class="quick-create-button" #quickCreateMenuTrigger="matMenuTrigger" [disabled]="isQuickCreating" aria-label="Crear" matTooltip="Crear">
      <mat-icon aria-hidden="true">add_circle</mat-icon>
    </button>

    <!-- Notificaciones -->
    <button mat-icon-button class="notification-button" [matMenuTriggerFor]="notificationMenu" #notificationMenuTrigger="matMenuTrigger" aria-label="Notificaciones" matTooltip="Notificaciones">
      <mat-icon [matBadge]="notificationCount" matBadgeColor="warn" matBadgeSize="small" aria-hidden="true">
        notifications
      </mat-icon>
    </button>

    <!-- Menú de usuario o login -->
    <ng-container *ngIf="isAuthenticated; else loginButton">
      <button mat-button [matMenuTriggerFor]="userMenu" class="user-button" #userMenuTrigger="matMenuTrigger" aria-label="Menú de usuario" matTooltip="Cuenta">
        <div class="user-info">
          <img [src]="userAvatar"
               [alt]="userName || 'Usuario'"
               class="user-avatar"
               (error)="onAvatarError($event)">
          <div class="user-details hide-mobile" *ngIf="userName">
            <div class="user-name">{{ userName }}</div>
            <div class="user-role" *ngIf="userRole">{{ getRoleLabel(userRole) }}</div>
          </div>
          <mat-icon class="dropdown-icon" aria-hidden="true">expand_more</mat-icon>
        </div>
      </button>
    </ng-container>
    <ng-template #loginButton>
        <button mat-stroked-button color="accent" (click)="goToAbout()" class="about-btn show-mobile" aria-label="Conocer FactuFast">
        <mat-icon>travel_explore</mat-icon>
      </button>
      <button mat-stroked-button color="primary" (click)="goToLogin()" class="login-btn">
        <mat-icon>login</mat-icon>
        <span>Iniciar sesión</span>
      </button>
    </ng-template>
  </div>
</mat-toolbar>

<!-- Menú de notificaciones -->
<mat-menu #notificationMenu="matMenu" class="notification-menu" xPosition="before" yPosition="below">
  <div class="notification-header">
    <h3>Notificaciones</h3>
    <div class="notification-actions" *ngIf="notifications.length > 0">
      <button mat-icon-button matTooltip="Marcar todas como leídas" (click)="markAllNotificationsAsRead()">
  <mat-icon aria-hidden="true">done_all</mat-icon>
      </button>
      <button mat-icon-button matTooltip="Limpiar" (click)="clearAllNotifications()">
  <mat-icon aria-hidden="true">delete_sweep</mat-icon>
      </button>
    </div>
  </div>
  <mat-divider></mat-divider>

  <div class="notifications-list" *ngIf="notifications.length > 0; else noNotifications">
    <div *ngFor="let notification of notifications"
         class="notification-item"
         [class.unread]="!notification.read"
         (click)="handleNotificationClick(notification)">
      
      <div class="notification-icon">
        <mat-icon [style.color]="getNotificationColor(notification.type)" aria-hidden="true">
          {{ getNotificationIcon(notification.type) }}
        </mat-icon>
      </div>
      
      <div class="notification-content">
        <div class="notification-title">{{ notification.title }}</div>
        <div class="notification-message">{{ notification.message }}</div>
        <div class="notification-time">{{ formatNotificationTime(notification.timestamp) }}</div>
      </div>

      <button mat-icon-button 
              (click)="dismissNotification(notification, $event)"
              class="notification-dismiss">
        <mat-icon aria-hidden="true">close</mat-icon>
      </button>
    </div>
  </div>

  <ng-template #noNotifications>
    <div class="no-notifications">
  <mat-icon class="no-notifications-icon" aria-hidden="true">notifications_none</mat-icon>
      <p>No hay notificaciones nuevas</p>
    </div>
  </ng-template>

  <mat-divider></mat-divider>
  <div class="notifications-footer">
    <button mat-button 
            color="primary" 
            (click)="viewAllNotifications()"
            class="view-all-btn">
      Ver todas las notificaciones
    </button>
  </div>
</mat-menu>

<!-- Menú de creación rápida -->
<mat-menu #quickCreateMenu="matMenu" class="quick-create-menu" xPosition="before" yPosition="below">
  <button mat-menu-item (click)="quickCreate('invoice')">
  <mat-icon color="primary" aria-hidden="true">receipt_long</mat-icon>
    <span>Nueva Factura</span>
  </button>
  <button mat-menu-item (click)="quickCreate('client')">
  <mat-icon color="accent" aria-hidden="true">person_add</mat-icon>
    <span>Nuevo Cliente</span>
  </button>
  <button mat-menu-item (click)="quickCreate('quote')">
  <mat-icon color="warn" aria-hidden="true">format_quote</mat-icon>
    <span>Nueva Cotización</span>
  </button>
</mat-menu>

<!-- Menú de usuario -->
<mat-menu #userMenu="matMenu" class="user-menu" xPosition="before" yPosition="below">
  <!-- Header -->
  <div class="user-menu-header" (click)="$event.stopPropagation()">
  <img [src]="userAvatar" [alt]="userName || 'Usuario'" class="user-menu-avatar">
    <div class="user-menu-info">
      <div class="user-menu-name">{{ userName }}</div>
      <div class="user-menu-email">{{ userEmail }}</div>
      <div class="user-menu-role">
        <mat-chip size="small" [color]="getRoleColor(userRole)">
          {{ getRoleLabel(userRole) }}
        </mat-chip>
      </div>
    </div>
  </div>

  <mat-divider></mat-divider>

  <!-- Items -->
  <button mat-menu-item (click)="goToProfile()" class="menu-item" aria-label="Ir a mi perfil">
    <mat-icon aria-hidden="true">person</mat-icon>
    <span>Mi Perfil</span>
  </button>

  <button mat-menu-item (click)="goToSettings()" class="menu-item" aria-label="Abrir configuración">
    <mat-icon aria-hidden="true">settings</mat-icon>
    <span>Configuración</span>
  </button>

  <button mat-menu-item (click)="toggleTheme()" class="menu-item" aria-label="Cambiar tema">
    <mat-icon aria-hidden="true">{{ isDarkTheme ? 'light_mode' : 'dark_mode' }}</mat-icon>
    <span>{{ isDarkTheme ? 'Modo Claro' : 'Modo Oscuro' }}</span>
  </button>

  <mat-divider></mat-divider>

  <button mat-menu-item (click)="viewHelp()" class="menu-item" aria-label="Ayuda y soporte">
    <mat-icon aria-hidden="true">help</mat-icon>
    <span>Ayuda y Soporte</span>
  </button>

  <button mat-menu-item (click)="viewUpdates()" class="menu-item" aria-label="Ver novedades y actualizaciones">
    <mat-icon [matBadge]="updateCount > 0 ? updateCount : null" 
              matBadgeColor="accent" 
              matBadgeSize="small" aria-hidden="true">
      system_update
    </mat-icon>
    <span>Novedades</span>
  </button>

  <mat-divider></mat-divider>

  <button mat-menu-item (click)="confirmLogout()" class="menu-item logout-item" aria-label="Cerrar sesión">
    <mat-icon aria-hidden="true">logout</mat-icon>
    <span>Cerrar Sesión</span>
  </button>
</mat-menu>
