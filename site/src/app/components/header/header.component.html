<mat-toolbar class="header-toolbar">
  <div class="header-content">
    <!-- Botón de menú -->
    <button mat-icon-button class="menu-button" (click)="toggleSidebar()">
      <mat-icon>menu</mat-icon>
    </button>

    <!-- Logo y título -->
    <div class="brand">
      <mat-icon class="brand-icon">receipt</mat-icon>
      <span class="brand-name">FactuFast</span>
    </div>

    <!-- Buscador Desktop -->
    <mat-form-field appearance="outline" class="search-field hide-mobile" *ngIf="!showMobileSearch">
      <mat-label>Buscar...</mat-label>
      <input matInput type="text" [value]="searchTerm" (input)="onSearch($event)">
      <button *ngIf="searchTerm" mat-icon-button matSuffix (click)="clearSearch()" type="button">
        <mat-icon>close</mat-icon>
      </button>
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>

    <!-- Icono para abrir buscador en mobile -->
    <button mat-icon-button class="show-mobile-search-btn show-mobile" (click)="toggleMobileSearch()" *ngIf="!showMobileSearch">
      <mat-icon>search</mat-icon>
    </button>
    <div class="mobile-search-container show-mobile" *ngIf="showMobileSearch">
      <mat-form-field appearance="outline" class="mobile-search-field">
        <mat-label>Buscar...</mat-label>
        <input matInput type="text" [value]="searchTerm" (input)="onSearch($event)">
        <button *ngIf="searchTerm" mat-icon-button matSuffix (click)="clearSearch()" type="button">
          <mat-icon>close</mat-icon>
        </button>
        <button mat-icon-button matSuffix (click)="toggleMobileSearch()" type="button">
          <mat-icon>keyboard_hide</mat-icon>
        </button>
      </mat-form-field>
    </div>

    <span class="spacer"></span>

    <!-- Acciones rápidas -->
    <button mat-icon-button [matMenuTriggerFor]="quickCreateMenu" class="quick-create-button" #quickCreateMenuTrigger="matMenuTrigger" [disabled]="isQuickCreating">
      <mat-icon>add_circle</mat-icon>
    </button>

    <!-- Notificaciones -->
    <button mat-icon-button class="notification-button" [matMenuTriggerFor]="notificationMenu">
      <mat-icon [matBadge]="notificationCount" matBadgeColor="warn" matBadgeSize="small">
        notifications
      </mat-icon>
    </button>

    <!-- Menú de usuario o login -->
    <ng-container *ngIf="isAuthenticated; else loginButton">
      <button mat-button [matMenuTriggerFor]="userMenu" class="user-button">
        <div class="user-info">
          <img [src]="userAvatar"
               [alt]="userName || 'Usuario'"
               class="user-avatar"
               (error)="onAvatarError($event)">
          <div class="user-details hide-mobile" *ngIf="userName">
            <div class="user-name">{{ userName }}</div>
            <div class="user-role" *ngIf="userRole">{{ getRoleLabel(userRole) }}</div>
          </div>
          <mat-icon class="dropdown-icon">expand_more</mat-icon>
        </div>
      </button>
    </ng-container>
    <ng-template #loginButton>
      <button mat-stroked-button color="primary" (click)="goToLogin()" class="login-btn">
        <mat-icon>login</mat-icon>
        <span>Iniciar sesión</span>
      </button>
    </ng-template>
  </div>
</mat-toolbar>

<!-- Menú de notificaciones -->
<mat-menu #notificationMenu="matMenu" class="notification-menu">
  <div class="notification-header">
    <h3>Notificaciones</h3>
    <div class="notification-actions" *ngIf="notifications.length > 0">
      <button mat-icon-button matTooltip="Marcar todas como leídas" (click)="markAllNotificationsAsRead()">
        <mat-icon>done_all</mat-icon>
      </button>
      <button mat-icon-button matTooltip="Limpiar" (click)="clearAllNotifications()">
        <mat-icon>delete_sweep</mat-icon>
      </button>
    </div>
  </div>
  <mat-divider></mat-divider>

  <div class="notifications-list" *ngIf="notifications.length > 0; else noNotifications">
    <div *ngFor="let notification of notifications"
         class="notification-item"
         [class.unread]="!notification.read"
         (click)="handleNotificationClick(notification)">
      
      <div class="notification-icon">
        <mat-icon [style.color]="getNotificationColor(notification.type)">
          {{ getNotificationIcon(notification.type) }}
        </mat-icon>
      </div>
      
      <div class="notification-content">
        <div class="notification-title">{{ notification.title }}</div>
        <div class="notification-message">{{ notification.message }}</div>
        <div class="notification-time">{{ formatNotificationTime(notification.timestamp) }}</div>
      </div>

      <button mat-icon-button 
              (click)="dismissNotification(notification, $event)"
              class="notification-dismiss">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  </div>

  <ng-template #noNotifications>
    <div class="no-notifications">
      <mat-icon class="no-notifications-icon">notifications_none</mat-icon>
      <p>No hay notificaciones nuevas</p>
    </div>
  </ng-template>

  <mat-divider></mat-divider>
  <div class="notifications-footer">
    <button mat-button 
            color="primary" 
            (click)="viewAllNotifications()"
            class="view-all-btn">
      Ver todas las notificaciones
    </button>
  </div>
</mat-menu>

<!-- Menú de creación rápida -->
<mat-menu #quickCreateMenu="matMenu" class="quick-create-menu">
  <button mat-menu-item (click)="quickCreate('invoice')">
    <mat-icon color="primary">receipt_long</mat-icon>
    <span>Nueva Factura</span>
  </button>
  <button mat-menu-item (click)="quickCreate('client')">
    <mat-icon color="accent">person_add</mat-icon>
    <span>Nuevo Cliente</span>
  </button>
  <button mat-menu-item (click)="quickCreate('quote')">
    <mat-icon color="warn">format_quote</mat-icon>
    <span>Nueva Cotización</span>
  </button>
</mat-menu>

<!-- Menú de usuario -->
<mat-menu #userMenu="matMenu" class="user-menu">
  <!-- Header -->
  <div class="user-menu-header" (click)="$event.stopPropagation()">
    <img [src]="userAvatar" [alt]="userName" class="user-menu-avatar">
    <div class="user-menu-info">
      <div class="user-menu-name">{{ userName }}</div>
      <div class="user-menu-email">{{ userEmail }}</div>
      <div class="user-menu-role">
        <mat-chip size="small" [color]="getRoleColor(userRole)">
          {{ getRoleLabel(userRole) }}
        </mat-chip>
      </div>
    </div>
  </div>

  <mat-divider></mat-divider>

  <!-- Items -->
  <button mat-menu-item (click)="goToProfile()" class="menu-item">
    <mat-icon>person</mat-icon>
    <span>Mi Perfil</span>
  </button>

  <button mat-menu-item (click)="goToSettings()" class="menu-item">
    <mat-icon>settings</mat-icon>
    <span>Configuración</span>
  </button>

  <button mat-menu-item (click)="toggleTheme()" class="menu-item">
    <mat-icon>{{ isDarkTheme ? 'light_mode' : 'dark_mode' }}</mat-icon>
    <span>{{ isDarkTheme ? 'Modo Claro' : 'Modo Oscuro' }}</span>
  </button>

  <mat-divider></mat-divider>

  <button mat-menu-item (click)="viewHelp()" class="menu-item">
    <mat-icon>help</mat-icon>
    <span>Ayuda y Soporte</span>
  </button>

  <button mat-menu-item (click)="viewUpdates()" class="menu-item">
    <mat-icon [matBadge]="updateCount > 0 ? updateCount : null" 
              matBadgeColor="accent" 
              matBadgeSize="small">
      system_update
    </mat-icon>
    <span>Novedades</span>
  </button>

  <mat-divider></mat-divider>

  <button mat-menu-item (click)="confirmLogout()" class="menu-item logout-item">
    <mat-icon>logout</mat-icon>
    <span>Cerrar Sesión</span>
  </button>
</mat-menu>
